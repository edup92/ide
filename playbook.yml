---
- name: vscode
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Installations
      block:
        - name: Update APT cache
          apt:
            update_cache: true
        - name: Basic Packages
          apt:
            name:
              - software-properties-common
              - gnupg
              - curl
              - ca-certificates
              - nano
              - unzip
            state: present
        - name: Create Docker keyrings directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
        - name: Download Docker GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: "0644"
        - name: Add Docker repository to Apt sources
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            content: |
              deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename | default('noble') }} stable
        - name: Update apt cache
          apt:
            update_cache: true
        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true

    - name: Create vscode user and directories
      block:
        - name: Create vscode user
          user:
            name: code
            shell: /bin/bash
            home: /opt/code-server
            create_home: no
            groups: docker
            append: yes
            state: present
          register: code_user
        - name: Create Code directories
          file:
            path: "{{ item.path }}"
            state: directory
            owner: code
            group: code
            mode: "{{ item.mode }}"
          loop:
            - { path: "/opt/code-server", mode: "0700" }
            - { path: "/opt/code-server/docker", mode: "0755" }
            - { path: "/opt/code-server/ssl", mode: "0755" }
            - { path: "/opt/code-server/workspace", mode: "0775" }
            - { path: "/opt/code-server/config", mode: "0755" }
            - { path: "/opt/code-server/config/vscode-user", mode: "0775" }
            - { path: "/opt/code-server/env", mode: "0755" }

    - name: Generate self signed SSL
      block:
        - name: Generate self-signed SSL certificate
          command: >
            openssl req -x509 -nodes -days 365 -newkey rsa:2048
            -keyout /opt/code-server/ssl/privkey.pem
            -out /opt/code-server/ssl/fullchain.pem
            -subj "/C=ES/ST=Madrid/L=Madrid/O=Code/CN={{ domain }}"
          args:
            creates: "/opt/code-server/ssl/fullchain.pem"
        - name: Set SSL files permissions
          file:
            path: "{{ item }}"
            owner: code
            group: code
            mode: "0644"
          loop:
            - /opt/code-server/ssl/privkey.pem
            - /opt/code-server/ssl/fullchain.pem

    - name: Github PEM
      block:
        - name: Copy GitHub private key from local file
          copy:
            src: pem_github_private
            dest: /opt/code-server/config/github_pem
            owner: code
            group: code
            mode: "0600"
        - name: Generate Code settings.json
          copy:
            dest: "/opt/code-server/config/vscode-user/settings.json" 
            content: |
              {
                "editor.tabSize": 2,
                "editor.insertSpaces": true,
                "editor.detectIndentation": false,
                "editor.defaultFormatter": "esbenp.prettier-vscode",
                "python.formatting.provider": "black",
                "editor.formatOnSave": true,
                "editor.minimap.enabled": false,
                "workbench.colorTheme": "Tokyo Night",
                "window.commandCenter": false,
                "editor.lineNumbers": "on",
                "editor.stickyScroll.enabled": false,
                "files.autoSave": "onWindowChange",
                "workbench.editorAssociations": {
                    "*.md": "vscode.markdown.preview.editor",
                    "*.MD": "vscode.markdown.preview.editor"
                },
                "workbench.sideBar.location": "left",
                "workbench.statusBar.visible": true,
                "workbench.tree.enableStickyScroll": true,
                "workbench.view.alwaysShowHeaderActions": false,
                "window.density.editorTabHeight": "default",
                "git.autofetch": false,
                "git.enableSmartCommit": true,
                "git.postCommitCommand": "sync",
                "ansible.python.interpreterPath": "/usr/bin/python3",
                "ansible.validation.lint.enabled": true,
                "terminal.integrated.defaultProfile.linux": "bash",
                "security.workspace.trust.enabled": true,
                "security.workspace.trust.untrustedFolders": [],
                "security.workspace.trust.allowedFolders": [
                  "/home/coder/workspace"
                ],
                "chat.disableAIFeatures": true,
                "chatgpt.openOnStartup": false,
                "chatgpt.model": "gpt-5"
              }
            owner: code
            group: code
            mode: "0644"

    - name: Create docker config files
      block:
        - name: Ensure cookie secret file exists
          copy:
            dest: /opt/code-server/docker/oauth_cookie_secret.txt
            content: "{{ lookup('pipe', 'openssl rand -base64 48 | tr -dc A-Za-z0-9 | head -c 32') }}"
            owner: code
            group: code
            mode: "0600"
            force: no
        - name: Read cookie secret from remote file
          slurp:
            src: /opt/code-server/docker/oauth_cookie_secret.txt
          register: cookie_secret_raw
        - name: Set fact for cookie secret
          set_fact:
            oauth_cookie_secret: "{{ cookie_secret_raw.content | b64decode }}"    
        - name: Generate oauth proxy allowed accounts
          copy:
            dest: "/opt/code-server/docker/oauth_allowed_emails.txt"
            content: "{{ admin_email }}"
            owner: code
            group: code
            mode: "0644"
        - name: Crear Dockerfile para code-server personalizado
          copy:
            dest: /opt/code-server/docker/Dockerfile
            owner: code
            group: code
            mode: "0644"
            content: |
              FROM ubuntu:22.04
              ENV DEBIAN_FRONTEND=noninteractive

              # 1. Dependencias base
              RUN apt-get update && \
                  apt-get install -y --no-install-recommends \
                    curl \
                    wget \
                    git \
                    gnupg \
                    nano \
                    jq \
                    lsb-release \
                    ca-certificates \
                    software-properties-common \
                    openssh-client \
                    sudo \
                    unzip && \
                  rm -rf /var/lib/apt/lists/*

              # 2. Python
              RUN apt-get update && \
                  apt-get install -y --no-install-recommends python3 python3-pip && \
                  rm -rf /var/lib/apt/lists/*

              # 3. Node.js LTS
              RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
                  apt-get install -y nodejs && \
                  rm -rf /var/lib/apt/lists/*

              # 4. Terraform
              RUN curl -fsSL https://apt.releases.hashicorp.com/gpg \
                    | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg && \
                  echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
                    https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
                    > /etc/apt/sources.list.d/hashicorp.list && \
                  apt-get update && \
                  apt-get install -y terraform && \
                  rm -rf /var/lib/apt/lists/*

              # 5. Terragrunt
              ENV TG_VERSION="v0.93.8"
              ENV OS="linux"
              ENV ARCH="amd64"
              ENV TG_BIN="terragrunt_${OS}_${ARCH}"

              RUN curl -sL "https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VERSION}/${TG_BIN}" \
                    -o /usr/local/bin/terragrunt && \
                  chmod +x /usr/local/bin/terragrunt

              # 6. Ansible
              RUN add-apt-repository --yes --update ppa:ansible/ansible && \
                  apt-get install -y --no-install-recommends ansible && \
                  rm -rf /var/lib/apt/lists/*

              # 7. Instalar code-server
              RUN curl -fsSL https://code-server.dev/install.sh | bash

              # 8. Crear usuario coder
              RUN useradd -m coder && \
                  echo "coder ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/90-coder

              ARG UID={{ code_user.uid }}
              ARG GID={{ code_user.group }}
              RUN groupmod -g $GID coder && usermod -u $UID -g $GID coder

              # 9. Crear directorios
              RUN mkdir -p /home/coder/.ssh && \
                  mkdir -p /home/coder/.local/share/code-server && \
                  mkdir -p /home/coder/.config/code-server && \
                  mkdir -p /home/coder/workspace && \
                  chown -R coder:coder /home/coder

              # 10. Crear .gitmessage.txt en /home/coder
              RUN echo "Short, descriptive title (max 50 chars)" \
                    > /home/coder/.gitmessage.txt && \
                  chown coder:coder /home/coder/.gitmessage.txt

              # 11. ConfiguraciÃ³n SSH (sin claves)
              RUN echo "Host github.com\n  IdentityFile ~/.ssh/id_rsa\n  StrictHostKeyChecking no" \
                  > /home/coder/.ssh/config && \
                  chown coder:coder /home/coder/.ssh/config && \
                  chmod 600 /home/coder/.ssh/config

              # 12. Git global config
              RUN git config --global user.name "code-server" && \
                  git config --global user.email "{{ admin_email }}" && \
                  git config --global commit.template /home/coder/.gitmessage.txt

              # 13. Cambiar a usuario coder
              USER coder
              ENV HOME=/home/coder

              # 14. WORKDIR
              WORKDIR /home/coder/workspace

              # 15. Entrypoint
              COPY entrypoint.sh /usr/local/bin/entrypoint.sh
              ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
        - name: Create entrypoint.sh
          copy:
            dest: /opt/code-server/docker/entrypoint.sh
            owner: code
            group: code
            mode: "0755"
            content: |
              #!/bin/bash

              # Private key

              chmod 600 /home/coder/.ssh/id_rsa
              chown coder:coder /home/coder/.ssh/id_rsa

              # Extensions

              EXT_DIR="/home/coder/.local/share/code-server/extensions"
              if [ ! -d "$EXT_DIR" ] || [ -z "$(ls -A $EXT_DIR)" ]; then
                  echo "Installing VSCode extensions..."
                  code-server --install-extension github.copilot
                  code-server --install-extension hashicorp.terraform
                  code-server --install-extension redhat.ansible
                  code-server --install-extension ms-python.python
                  code-server --install-extension enkia.tokyo-night
                  code-server --install-extension esbenp.prettier-vscode
                  code-server --install-extension openai.chatgpt
              fi

              # Lanzar code-server en workspace
              exec code-server --bind-addr 0.0.0.0:8443 --auth none
        - name: Generate OAuth Proxy env
          copy:
            dest: "/opt/code-server/env/oauth-proxy.env"
            content: |
              OAUTH2_PROXY_PROVIDER=google
              OAUTH2_PROXY_CLIENT_ID={{ oauth_client_id }}
              OAUTH2_PROXY_CLIENT_SECRET={{ oauth_client_secret }}
              OAUTH2_PROXY_COOKIE_SECRET={{ oauth_cookie_secret }}
              OAUTH2_PROXY_REDIRECT_URL=https://{{ domain }}/oauth2/callback
              OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE=/etc/oauth2_proxy/allowed_emails.txt
              OAUTH2_PROXY_COOKIE_DOMAIN={{ domain }}
              OAUTH2_PROXY_TLS_CERT_FILE=/ssl/fullchain.pem
              OAUTH2_PROXY_TLS_KEY_FILE=/ssl/privkey.pem
              OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:443
              OAUTH2_PROXY_PASS_USER_HEADERS=true
              OAUTH2_PROXY_SET_XAUTHREQUEST=true
              OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
              OAUTH2_PROXY_UPSTREAMS=http://code:8443
              OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY=true
              OAUTH2_PROXY_COOKIE_SECURE=true
              OAUTH2_PROXY_PROXY_HEADERS=X-Forwarded-Proto:https
            owner: code
            group: code
            mode: "0600"
        - name: Generate docker-compose.yml
          copy:
            dest: "/opt/code-server/docker/docker-compose.yml"
            content: |
              networks:

                code-net:
                  driver: bridge

              services:

                code:
                  build:
                    context: .
                    dockerfile: Dockerfile
                  container_name: code-server
                  user: "{{ code_user.uid }}:{{ code_user.group }}"
                  volumes:
                    - /opt/code-server/workspace:/home/coder/workspace
                    - /opt/code-server/config/vscode-user:/home/coder/.local/share/code-server/User
                    - /opt/code-server/config/github_pem:/home/coder/.ssh/id_rsa
                    - ./entrypoint.sh:/entrypoint.sh
                  entrypoint: ["/entrypoint.sh"]
                  networks:
                    - code-net
                  restart: unless-stopped

                oauth2-proxy:
                  image: quay.io/oauth2-proxy/oauth2-proxy:latest
                  container_name: code-oauth2-proxy
                  restart: unless-stopped
                  user: "{{ code_user.uid }}:{{ code_user.group }}"
                  ports:
                    - "443:443"
                  networks:
                    - code-net
                  volumes:
                    - ./oauth_allowed_emails.txt:/etc/oauth2_proxy/allowed_emails.txt:ro
                    - ../ssl:/ssl
                  env_file:
                    - ../env/oauth-proxy.env
            owner: code
            group: code
            mode: "0644"
        - name: Create systemd service for Code
          copy:
            dest: "/etc/systemd/system/code-server.service"
            content: |
              [Unit]
              Description=Code Docker Compose
              Requires=docker.service
              After=docker.service

              [Service]
              Type=oneshot
              RemainAfterExit=yes
              WorkingDirectory=/opt/code-server/docker
              # Debug solo para build + launch
              Environment=COMPOSE_DOCKER_CLI_BUILD=1
              Environment=DOCKER_BUILDKIT=1

              # --verbose => verbose del compose
              # --build   => rebuild si es necesario
              ExecStart=/usr/bin/docker compose --verbose up -d --build
              ExecStop=/usr/bin/docker compose down
              TimeoutStartSec=0

              [Install]
              WantedBy=multi-user.target
            mode: "0644"
        - name: Enable and start Code service
          systemd:
            name: code-server
            enabled: true
            state: restarted
            daemon_reload: true

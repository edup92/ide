---
- name: vscode
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Installations
      block:
        - name: Install prerequisites
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
              - nano
              - unzip
            state: present
            update_cache: true
        - name: Ensure keyrings directory exists
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
        - name: Download Docker GPG key (ASCII)
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /tmp/docker.gpg
            mode: "0644"
        - name: Convert GPG key to dearmored format
          command: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /tmp/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg
        - name: Configure Docker APT repo
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            content: |
              deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_facts['lsb']['codename'] }} stable
            mode: "0644"
        - name: Update APT cache
          apt:
            update_cache: true
        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true

    - name: Create vscode user and directories
      block:
        - name: Create vscode user
          user:
            name: vscode
            shell: /bin/bash
            home: /opt/vscode
            create_home: no
            groups: docker
            append: yes
            state: present
          register: vscode_user
        - name: Create Code directories
          file:
            path: "{{ item.path }}"
            state: directory
            owner: vscode
            group: vscode
            mode: "{{ item.mode }}"
          loop:
            - { path: "/opt/vscode", mode: "0700" }
            - { path: "/opt/vscode/docker", mode: "0755" }
            - { path: "/opt/vscode/data", mode: "0775" }
            - { path: "/opt/vscode/extensions", mode: "0775" }
            - { path: "/opt/vscode/userdata", mode: "0755" }
            - { path: "/opt/vscode/pem", mode: "0755" }
            - { path: "/opt/vscode/env", mode: "0755" }

    - name: Vscode config
      block:
        - name: Copy GitHub private key from local file
          copy:
            dest: /opt/vscode/pem/github_pem
            content: "{{ pem_github }}"
            owner: vscode
            group: vscode
            mode: "0600"
        - name: Generate Code settings.json
          copy:
            dest: "/opt/vscode/userdata/settings.json" 
            content: |
              {
                "editor.tabSize": 2,
                "editor.insertSpaces": true,
                "editor.detectIndentation": false,
                "editor.defaultFormatter": "esbenp.prettier-vscode",
                "python.formatting.provider": "black",
                "editor.formatOnSave": true,
                "editor.minimap.enabled": false,
                "workbench.colorTheme": "Tokyo Night",
                "window.commandCenter": false,
                "editor.lineNumbers": "on",
                "editor.stickyScroll.enabled": false,
                "files.autoSave": "onWindowChange",
                "workbench.editorAssociations": {
                    "*.md": "vscode.markdown.preview.editor",
                    "*.MD": "vscode.markdown.preview.editor"
                },
                "workbench.sideBar.location": "left",
                "workbench.statusBar.visible": true,
                "workbench.tree.enableStickyScroll": true,
                "workbench.view.alwaysShowHeaderActions": false,
                "window.density.editorTabHeight": "default",
                "git.autofetch": false,
                "git.enableSmartCommit": true,
                "git.postCommitCommand": "sync",
                "ansible.python.interpreterPath": "/usr/bin/python3",
                "ansible.validation.lint.enabled": true,
                "terminal.integrated.defaultProfile.linux": "bash",
                "security.workspace.trust.enabled": true,
                "security.workspace.trust.untrustedFolders": [],
                "security.workspace.trust.allowedFolders": [
                  "/home/coder/workspace"
                ],
                "chat.disableAIFeatures": true,
                "chatgpt.openOnStartup": true
              }
            owner: vscode
            group: vscode
            mode: "0644"

    - name: Create docker config files
      block:
        - name: Generate dockerfile
          copy:
            dest: "/opt/vscode/docker/Dockerfile"
            content: |-
              FROM mcr.microsoft.com/vscode/server:stable

              USER root

              # Base tools
              RUN apt-get update && apt-get install -y \
                  git \
                  unzip \
                  nano \
                  wget \
                  curl \
                  jq \
                  software-properties-common \
                  gnupg \
                && apt-get clean \
                && rm -rf /var/lib/apt/lists/*

              # Python
              RUN apt-get update && apt-get install -y \
                  python3 \
                  python3-pip \
                  python3-venv \
                && apt-get clean \
                && rm -rf /var/lib/apt/lists/*

              # Ansible
              RUN add-apt-repository --yes --update ppa:ansible/ansible \
                && apt-get update \
                && apt-get install -y ansible \
                && apt-get clean \
                && rm -rf /var/lib/apt/lists/*

              # Node.js LTS
              RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
                && apt-get install -y nodejs \
                && apt-get clean \
                && rm -rf /var/lib/apt/lists/*

              # Terraform
              RUN curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp.gpg \
                && echo "deb [signed-by=/usr/share/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
                  > /etc/apt/sources.list.d/hashicorp.list \
                && apt-get update \
                && apt-get install -y terraform \
                && apt-get clean \
                && rm -rf /var/lib/apt/lists/*

              # Terragrunt
              RUN wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.93.8/terragrunt_linux_amd64 \
                && install -m 0755 terragrunt_linux_amd64 /usr/local/bin/terragrunt \
                && rm terragrunt_linux_amd64

              # AWS CLI v2
              RUN curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
                && unzip awscliv2.zip \
                && ./aws/install \
                && rm -rf aws awscliv2.zip

              # Prepare SSH directory and known_hosts
              RUN mkdir -p /home/vscode/.ssh \
                && chmod 700 /home/vscode/.ssh \
                && touch /home/vscode/.ssh/known_hosts \
                && ssh-keyscan github.com >> /home/vscode/.ssh/known_hosts \
                && chown -R vscode:vscode /home/vscode/.ssh

              # SSH config file to force usage of our mounted key
              RUN echo "Host github.com\n  IdentityFile ~/.ssh/id_ed25519\n  StrictHostKeyChecking yes" \
                > /home/vscode/.ssh/config \
                && chmod 600 /home/vscode/.ssh/config \
                && chown vscode:vscode /home/vscode/.ssh/config

              # GIT COMMIT MESSAGE TEMPLATE
              RUN echo "Short, descriptive title (max 50 chars)\n\n# Describe here what changed and why.\n# Use bullets if needed:\n# - Change 1\n# - Change 2\n" \
                > /home/vscode/.gitmessage \
                && chown vscode:vscode /home/vscode/.gitmessage

              RUN git config --system commit.template /home/vscode/.gitmessage

              # GLOBAL GIT CONFIG (user.name + user.email)
              ARG admin_email
              RUN git config --global user.name "vscode" \
                && git config --global user.email "${admin_email}"

              ############################################################
              # INSTALL VSCODE EXTENSIONS (OFFICIAL MICROSOFT VS CODE SERVER)
              ############################################################

              # Create extensions folder
              RUN mkdir -p /home/vscode/.vscode-server/extensions

              # Download + extract helper
              RUN ext_dir="/home/vscode/.vscode-server/extensions" && \
                  download() { \
                    url="$1"; \
                    name="$2"; \
                    mkdir -p "$ext_dir/$name"; \
                    curl -fsSL "$url" -o /tmp/ext.vsix; \
                    unzip -q /tmp/ext.vsix -d "$ext_dir/$name"; \
                    rm /tmp/ext.vsix; \
                  }; \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/github/vsextensions/copilot/latest/vspackage" "github.copilot" && \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/hashicorp/vsextensions/terraform/latest/vspackage" "hashicorp.terraform" && \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/redhat/vsextensions/ansible/latest/vspackage" "redhat.ansible" && \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/ms-python/vsextensions/python/latest/vspackage" "ms-python.python" && \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/enkia/vsextensions/tokyo-night/latest/vspackage" "enkia.tokyo-night" && \
                  download "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/esbenp/vsextensions/prettier-vscode/latest/vspackage" "esbenp.prettier-vscode"

              # Permissions
              RUN chown -R vscode:vscode /home/vscode/.vscode-server

              # Return to vscode user
              USER vscode
            owner: vscode
            group: vscode
            mode: "0644"
        - name: Generate docker-compose.yml
          copy:
            dest: "/opt/vscode/docker/docker-compose.yml"
            content: |-
              services:
                vscode:
                  build:
                    context: .
                    dockerfile: Dockerfile
                    args:
                      admin_email: "{{ admin_email }}"
                  container_name: vscode
                  restart: always
                  ports:
                    - "80:8000"
                  volumes:
                    - ../data:/workspace
                    - ../extensions:/home/vscode/.vscode-server/extensions
                    - ../userdata:/home/vscode/.vscode-server/data/User
                    - ../pem/github_pem:/home/vscode/.ssh/id_ed25519:ro
            owner: vscode
            group: vscode
            mode: "0644"
        - name: Create systemd service for Code
          copy:
            dest: "/etc/systemd/system/vscode-server.service"
            content: |
              [Unit]
              Description=Code Docker Compose
              Requires=docker.service
              After=docker.service

              [Service]
              Type=oneshot
              RemainAfterExit=yes
              # Rebuild + Up
              ExecStart=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml build
              ExecStart=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml up -d

              # Down cuando paras el servicio
              ExecStop=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml down
              TimeoutStartSec=0

              [Install]
              WantedBy=multi-user.target
            mode: "0644"
        - name: Enable and start vscode-server service
          systemd:
            name: vscode-server
            enabled: true
            state: restarted
            daemon_reload: true

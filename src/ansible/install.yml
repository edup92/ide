---
- name: vscode
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Installations
      block:
        - name: Install prerequisites
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
              - nano
              - unzip
            state: present
            update_cache: true
        - name: Ensure keyrings directory exists
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
        - name: Download Docker GPG key (ASCII)
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /tmp/docker.gpg
            mode: "0644"
        - name: Convert GPG key to dearmored format
          command: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /tmp/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg
        - name: Configure Docker APT repo
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            content: |
              deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_facts['lsb']['codename'] }} stable
            mode: "0644"
        - name: Update APT cache
          apt:
            update_cache: true
        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true

    - name: Create vscode user and directories
      block:
        - name: Create vscode user
          user:
            name: vscode
            shell: /bin/bash
            home: /opt/vscode
            create_home: no
            groups: docker
            append: yes
            state: present
          register: vscode_user
        - name: Read passwd entry for vscode
          ansible.builtin.getent:
            database: passwd
            key: vscode
        - name: Read group entry for vscode
          ansible.builtin.getent:
            database: group
            key: vscode
        - name: Set UID/GID facts from getent (future-proof)
          ansible.builtin.set_fact:
            vscode_uid: "{{ ansible_facts.getent_passwd['vscode'][1] | int }}"
            vscode_gid: "{{ ansible_facts.getent_passwd['vscode'][2] | int }}"
        - name: Create Code directories
          file:
            path: "{{ item.path }}"
            state: directory
            owner: vscode
            group: vscode
            mode: "{{ item.mode }}"
          loop:
            - { path: "/opt/vscode", mode: "0700" }
            - { path: "/opt/vscode/docker", mode: "0755" }
            - { path: "/opt/vscode/data", mode: "0775" }
            - { path: "/opt/vscode/settings", mode: "0775" }
            - { path: "/opt/vscode/pem", mode: "0755" }

    - name: Vscode config
      block:
        - name: Define branding favicon svg (base64)
          set_fact:
            favicon_svg_b64: |
              PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjRweCIgaGVpZ2h0PSI2NHB4IiB2aWV3Qm94PSIwIDAgNjQgNjQiIHZlcnNpb249IjEuMSI+CjxkZWZzPgo8ZmlsdGVyIGlkPSJhbHBoYSIgZmlsdGVyVW5pdHM9Im9iamVjdEJvdW5kaW5nQm94IiB4PSIwJSIgeT0iMCUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPgogIDxmZUNvbG9yTWF0cml4IHR5cGU9Im1hdHJpeCIgaW49IlNvdXJjZUdyYXBoaWMiIHZhbHVlcz0iMCAwIDAgMCAxIDAgMCAwIDAgMSAwIDAgMCAwIDEgMCAwIDAgMSAwIi8+CjwvZmlsdGVyPgo8aW1hZ2UgaWQ9ImltYWdlMzIiIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFFQUFBQUJBQ0FZQUFBQ3FhWEhlQUFBQUJtSkxSMFFBL3dEL0FQK2d2YWVUQUFBRmNFbEVRVlI0bk8xYmEyd1VWUlQrN2s1M1MydHJvWlVxZ2hTSTBhNUlJUUlxNzBDQlNEQ2hnRFVvS2hyVUtBUkJveVNFQ2kwYkpaS0lGRkJERkpMMkI1cUN2RkVnZ0tJU2pCWUVHNEdrWXRCb3FZVnFYN1RkdWJmNythTVd0clMwdXpPek04WGxTODZmM2Jubm5PL01QWGZPZlFFM0dGaC80aTZxdkxXVXA3K2o1RmVVT2EreGN1U3RUdnRsQ3lnelIxT05xYVRTMkZwRy9rM1prTWVhaFNsTyt4Z3hVRDN6S0ZWYWZWdnl3WEpQSGVYS2ZOYS8wZHRwZnkwRjllVlBVeVhySFpNUGxsUS9sYmVRalhmYzdiVHZwa0g5bzRWVW5rRG81SU1sV2FmeUZ0SS9OOTFwSG1HRDBBVGx3WGVNRWI5VzRwb29wK3ltWGpITWFWNGhnY1dhbThwYmFBMzVZUEVFS0xOM1VqLzRvTk1jcnd1VytlSXBNL2RZVC83YVFLeC9qOUNFY0pwd01GaWRrWXo0TDNaRDlCMXBpOEZBNlR6TkZrTWhnUFY5KzZEYmtrTVE0NGZhWjNWd3Z5N1JBK2lmbXc0dGZoL3dRWnE5bHBPa3kxNkRiVUc5WWhpMFA3KzJuendBVkx0ajdEZDZGWlRuSjBCTTNnNlVPRmJMTzVZQ1ZON3BRTzFtNEVJM3Azd0FBRWRTZ1BxeCtjRDVyVTZUQjlvSkFNdDg4ZFFyWHFKTVgwci9LSy9WQmluTGZYQ05YZy9vam84L2JjQ0dRLzBwVjUrOVdqQWtTY3JzeFlSbU9sVllwR2xVc3paRXRzQUpYNjQ2NkYrZFFmVjRXYnNQeW1tN1dKMlJiSmg4NmF1eGxBcy9zNXlBM0hySytFUXBLQURVOHgrbUduK3A0NGRmL0oweVowVFk1Q3N5RXlqN0hiRCs3WGtMV2Y3QUxWUnhUYVlDMEx6SzBxY2h0QWFwZnVvN0Y0Uk12cTdYN1pRSFRsaExmTUJsNmpPZnZXTERmQUQyL21pZ1lWRm42M0JzOUEyZ3lpdTFsTHhjZlpiK2JZTmEyVEVaQUJmRXN2N2hkbXNBMmJoMWFqSDFSWVBiSmE4dkdveVlrMGVCRlJhdXlLUjhncXFVNFNKMlJvbDFPZ0ZRYVVYR0k1aFdULzIrdWEzMHlhUnhWRU9yckh2enZScXBsOHk3dnY5bVU2QTJ2V2Z6YUdyR3lZeUM1Z0ZwYUZibzQwa29zdVFjZGEzRDJhSFpBQWdBNEQrMTNaRWdka0VralRIZWx4Yi9DcXhMQXhxc21XSnp6ZzdVNVQ4bmVpUldkZmlZaW1zeVUxUzVBRUQwU0t6QytUY25nVXUyR2xVRXJCcGdEZmtFQmFvOHZOVi9abWZrclVDckNvOUZtb1laV1I4Q08xNkl0T0gyTWVjUHNIYVdjRzg1R21vTHN6MmdUWWxMYUFKU0xZZUlXVzVVcVNFdzRURDg4VStLaEF0L2hkWE1paFFJaGtBVGhWdmtJckR0RmNBVE1LbzRkTVExTlhmNTF5ZUZTejdpb0gvVDdQQjJaTUtWUnlvb1A1MXN5a2V6bjhGT0RjaHZKbExkWDJNNWVha2Y0ZVdmN2pSRDNwWUFBQUQxa3VGVUV5OWFROTRUb0Z5WnoyTE5iWmE4RlFIb2Vvc1NYUTMvOXhUb3NBZlF2MmsyeExUUGdUT0paaDF0QXhFM0ZyR0xUNW9kQkNNRzZqc1htSTF1YUpLZ0tKbkxYSitoZExSa0x0QktZVFFYUWl6U05LaXNEYmFUQndCUk53SGRwaFJUWm8reTNUYlFzbkNac3lYeVhiNHpTWkxocE1UTjZiRFpGR0J0ZWs4azdEOWlqdnpBUWx6YW53SGMreGpRcTlHNG5pQ0lnaXdrdm4yOHN3VVIwekRYN1cvOEpURVh4QjVqMzJHdUtFVmcrZ2poT2IweCtHZmhyajZDd0poeFFGYTVJYjF0VUJFTDE1RDNxVkkzODJLQjVmV0lDMXgxemtDN0xhalpPMHg0MXB4cTcwL2hXWE1LYXNnb1lOa3ZKdjBMUXVVVDZGNzV3N1hMNHFZUjlSc2pRSlJ2alYxeE5KbzNSNjg0R29YYjQyM25BbVcrZU55Vyt4VEVReWtJZUxlTDJJMW56Wkp2cFYrVyt5QjY1MWlwMHd3Y09TTkUvZGg4dUNhczdRcW5SRzRla25MS3NJZzVzeDM4ZGlvd3FNWXBId0FIQXdBQXd0M3ZNQUlITW9GSkY1M3l3ZmtjOUtRV282bjNXR0RlYi9aYlQ1SmQ0cXd3OE45aGFYZmVQb2puQjlwbjlPT2Z1MHdBQUNlT3kxOTQyUlk3NGNDK0N4TUY3MXBSNEVVRVVYMWxwZ1dSdVRRVjRkV2xTQ0JxcjgwRkk2b3ZUcllncXEvT3RpQ3FMMCszZ0EyK3ZsUkwxMUVlLzU0eTVrdWF2RDcvTDBSZlA0OFRxT2tiQUFBQUFFbEZUa1N1UW1DQyIvPgo8bWFzayBpZD0ibWFzazAiPgogIDxnIGZpbHRlcj0idXJsKCNhbHBoYSkiPgo8dXNlIHhsaW5rOmhyZWY9IiNpbWFnZTMyIi8+CiAgPC9nPgo8L21hc2s+CjxpbWFnZSBpZD0iaW1hZ2UxNCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiB4bGluazpocmVmPSJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUVBQUFBQkFDQVlBQUFDcWFYSGVBQUFBQm1KTFIwUUEvd0QvQVArZ3ZhZVRBQUFJVzBsRVFWUjRuTzJhYTFCVjF4WEhmK2R4WDd3RVZFUlVFQUdWeHhVVVEyaUlSZzJJeEloaTFPaW5adHBPUDJXbW45cnBkREtkc1oxcGswNGZtZW1rbmZUeElVblRSSzJWeEFlSmNVYnRCQ1dDZ21KVXBMNHdhR0FNb2hDdVhDNlhmamhuY3c3WGk4Sjk4TEQ4Wis3Y2ZmYzlaKysxL251dHZkZFpaOEVVcGpDRktVeGhDbE9Zd2hUK1B5RTk1amZBd0ZnSU1sNlFBRmx2SzZZK0FhRjh2OTUrNHNoUUFRditWOTRNR1UxNUQwOFlFU3FhY2dvYUNZSUlDVU5KcytJV3dJdG1FZDR4bFRSTVVBR2IzallUb0REVTdCVTBoZnRNMXowUjFxQUNWc3pLWjVaRXMrWkhXMUVzMGR5bzNjOUhyMTNGVUY1R0k2WVB3eG9FRVpNU0VqQVhUVEdKZFQ5TkphL2lIV1FsV2YvZlRXZnJyL25UOXIrQnk0T2h2Q0JrQUlPRVNla1NDakFkVUhoeDUxS1diUGdIc2pKN3lQLzJtRlVVdk95aysrN250RGM5ME84WlFKQ210YzE3eHFTQ0FpVHkwbStmSWF2a3I4aHlyTityVkdzYUdVWGxKQzQ2eTRYUDJobXF1R2liQ1prMFVOanltMDBzWFBVMmt1UjQ1SldTSEVOOGFnVlpKWjJjM3ZPbDNpdU9SL0V0bWRxVGdnaUZGM2YrRzBXTkg5SFZFaW9SY2MremZQc0M3bHc5UVVkTEw1UGNKV1FVUzlLbzczTEViR1R6R3g5VC92TWN0RlBFaGthRUNLeGsvVnZsOFVIV3VFTG13ZjJhZ081VXJXbmtiS2prZS8vY2lrYUNGVTFwUlcrTEFFc1FNaUdoNE9xOHpvTENGY2hxM09odmx5eEVUUzhsZjFzU0xRMG42V3JyWTVLNWhFSmJrNTIySzFWa3JNeEhzU1FHTklyRm5vT3piQjJ4ODA3UmZLeVRTWFJLS0VBMEhUY2VjUDFNRlpuRm1haldsSUJHa3BWNEVoZHVKdjNaV3pUc2E5Wjd6Y3BQeUZOQ0l3QzhkTFU5NFB6K1QzQ3VUOExpeUF4d1BDdlJNOHZJMzVySWxlb1Q5TnoxTU1GZFFnSHNpQ2M4dDh0THpaNGo1RzJJeEJhNUxPQlJMUTRudWVXcnNVODd5YldhTGlhd1M0aGR1bC8vUFFBZU9QVitOZGxsWFRpbXJTVFFZMHhXRTVqajNFcEcwUTBhS3EvcXZSUE9KVVFlQUYwQVFVUS9kYnZPc25EMUxhS21yeUhRWTB5U3JFUW52TURTbCtLNWVLeUczdnY5VERDWFVEQ2U5ZnQxUWJ5SUo3djZ2UmRKTGJ4RVRNSmFrTlFBNTVDd1J1U3hkTk1xYkJFbnVINnFtd25rRW1JMUJMdytiWW16SDExamJtNGRzVW5ya0NRYmdVSlJaekhIV1VGeVFUT04rMXYwWG44dVliYklzRU1RSUo3ckpWTmJSaEJ5L3RBdDRtWWRaV2I2V2lRNUt1RFpKTmxCN095TjVGVkVjTzdBS1R5OVhoNTJDUmhEUzFCTWJUTUpFa01Ka2JqOG53NHNVWitTbExVYVdRNGdhaHlFaEMxeU9mbmJDbUdnbXBzTkxzYlJKUlEvZlVJUUdHb0pFdGRydXVqcnJpSTV2d2haVFFodVpzdGNrdk0zazdMc0VvMEh2OUo3emNxTHVjTktnajhDWU9ocURDV2g5YnlMdHVhUHlWaVppMkpKSHViK2tVR1NJNGlkczVFbEcxUWFENTMyY1FteE9ZZjFxQnlPQUhoNEx6RDJoSTZXWHBxUFY1RmRtb1pxeXdoU0JobDc5Tk1zMjdJRVYyYzFYMS9xeFZCWXlCZTJvL0pSQkFnTXRRQmhvajEzUGRSWEhtWkorVXlzRG1mUWtxaldWTktLTnBLVWVZNHZEN2ZwdmI2YllzaGRZaVFFZ0g4U0pEeTkvWHp4M25HYzY5M1lZNHFDbGthU280bWZ2eG5uK241cUsrdkJJK1lOVy9RNFVnSmdxUEtESWdOZWFqODhRM2JwWFJ5eHp4RjhCa2pHSGxORXdiWWN1anFxYVc5eTQ5OENRbUlKb3lGQU1PNDdzYll2MU8xdUpMM29NbEVKSlVnRUdqVWFVSzBMeUNncVoxWkdBeGVQaEMwVFBSb0M0R0VTK2pHN1JrUGxWZWJsMWhNN3B4UkpzZ1lxMUNBa09ZWVpxWnZKZnNGRjNhNnplbTlJWFdLMEJNRHdBWk9JR2x1Wm5sYk5qSlMxU0hKRUFPUDdRRkp3VEhzdVhKbm9RQWdROEJjd2FRSTBIV25IR25tWXBLdzFTSXIvbHkyamhjVzJtTVhGWmN5WVYwZlRzUTVDNUJMQkVJQ1BBRU5QaW10ZjNNZnRQa1R5c2hYSXlzd2c1OUVneTNFa1pHd2hzNlNEMDNzdTZMMUI1UmlDSlFDR0Q1Z2tXcys1dUgvN0FBc0tud3JvL1lOZlNDb1JjY1U4dFdNK3Q4OVgwM2s3cUV4MEtBZ1E4RTlDZTdPTHl5Y1BrRjJ5RU5XV0hyTFpWRnNtV2FWQlo2SkRTUUQ0SjBHbTUwNGY5WldIeVMxUHhPTElDZGxzbzg5RVA0UlFFd0NQaWhwcjloeGxTWmtXKzRjT1JpYjZ2N1VuNmJrelhDYmFuRzlBdE1OQkFQZ3FQL2p0OFZMN3dTbHkxblhobUxiQ1I2RGdZSEU0eVYyL1pwaE10SzgxaUk4U0xnSWVFelh1T3NlaVZUZUpuUDQ4b1Z3RWtZbE9mN2FGaHNvcm9oZmp5ZEtYRkRsY0JNRHdVYU5HeUptOVRTVG5uU1YyemxxMGw2bWh3Y09aYUY5WEVKVnhZU2NBL0VlTnh2N1FlUEFtQ1drMXhLZVVJc21QTHRBWUhVeVo2SmhxcnRkMFkxaUJzRWdaa01KTmdJQnYxR2lFemhlUHRCR1RkSXlFOUpLZ0VxNytvS2l6bUp1OWllU0NTelR1YjlYblZCQ1dtSmh1R1NzQzRGRzV4dWJqSGNqV1QwbktYb1dzakt4YVphUVl6RVJ2VkRoM3NBNVByNUJGWnUyUFU4YVNBREd4ZjNlNFVkdk50OThjSUxYZ084aHFZSy9waDRlRUxlcHBscjljd096c0ppS2lYWlR2TENacVJzSjRsSzhJQWtTTnNxZ21zUUV5S1lXeGJIM2piYXlSSzhJb3d3Q3V6ai96aCtKZmpMVUZtT0hQRW1UdWZlWG0vSkVxbkdXcFdPeUxRanpuQU82ZXcxeXJlNVcvNzlnTkRJeG5BWk9FY1NTWkxjRUtLR0MzOGVyZTE0aVo5ZjBRek9XbHIrY29WMnQrejk2ZjFHT2NUcDd4cnVBYWpnUWJvc3JzaC8vNkFUUG0vNHpBb3NZK0h0dzd5TVhQL2tqVjYxY0FONGJ5Zll5ekJRaVlTUkRsZFFvR0NRcXZ2THVkcEt4ZjZ0ZU5BQU51dXIrcHBPNkR0emp4VGd0RGE1dEZ2VE9BZHlJUUFBWUpJbHpWM2NCVWc3ampyWFdrRnZ3T0pQdXdvd3g0ZTdqZnZvOFQ3LzZGK3QxZm82MjRGMlBsUmFIM2hIRUJNOHdrcUJpbC9NSWFiRlQ4cXBERnhXOGkrZFEwZTczMzZManhJY2ZlZkovTDFSMW8xZXR1dE5VV0pKZ3RZTERFZnlJUkFKb0xDSGN3SzI5WVFsN0ZQSjU1NWJ0RXhDM0YyL2N0ZDFzLzU1UFg5M0g3UWhlR2VRdmxlMDE5WnVWQnQ0VC9BVGRRLzVUMlRFTHhBQUFBQUVsRlRrU3VRbUNDIi8+CjxpbWFnZSBpZD0iaW1hZ2UyNSIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiB4bGluazpocmVmPSJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUVBQUFBQkFDQVlBQUFDcWFYSGVBQUFBQm1KTFIwUUEvd0QvQVArZ3ZhZVRBQUFDODBsRVFWUjRuTzJiTVdnVFVSakgvKy91bW90SlM2WHFFS3RrRUFSeGxXWVNCRVhwNU9CaU8yU3dnazVLUlZ3TERxSkNRWWNpMHFKb0t4VUtWcGVBb3RiV1RaQlNLK2xRQjl0aUNxVnBFMnZQbU12ZGM3ZzdrN1RSbUtidHh5UHZCNC8zQWkrUC8vZkx1OHYwTVlpQkFzQUhRQXRHMm9LTnJSY2o2cTREN1V4VjlsbXB4TWp5d0pWblJuek1jUGZhQUV4M3pnS3czTS9jWGVjSzluRzJyV1ZzSEFWQUhRQUdRQWVnSWhEUTk5LzRmRk9wYjRxQzIya3JPVHVRSE9ycS8vbnhSUnI1b2owSm5oUytaZzExKzJ2Wk1Bb2NBU29BQnROVUdXZHgvK0ZqRjhDWVh3bnNiQWtlT2QzZWNEVGF5TTNNZFBicmVBWk9zWW83cTNDTEJxQjU1NGx5QXdEbkJxZ0ZzeCtBTDl5WG1sbTNrM1BUL3BHTWZSOTczSk1ldnY0RmpnRHYrbnUzSUFlQkhnR2c0RDNnRGgyT2dObC9mTWUwVnhaanF4K2U5eXdOWHAxR2lmZUFhQUxxM0ZtSEkwTXZJOERENXBuMDZPcmttN3ZKKytjbTRJamdFRXdBUS83NmV3Sjg0YjdVWEFWbmNHNnN2TTFNdnJxMzBOc3hEc0JXdGlEb1ZzTUxScVV3Rm1nNHZpTnlacWo1ZHJ3TFBwOWYyK1J3VzgxR2lpNEYwNXIyUmtQWFhzNkpkQU40aWJWVnpZRjF6WWZPaWlSZzg5SDBjRTBMWUl4cE5TMEFjUDVUYXhvcGdEb0FOVklBZFFCcXBBRHFBTlJJQWRRQnFKRUNxQU5RSXdWUUI2QkdDcUFPUUkwVVFCMkFHaW1BT2dBMVVnQjFBR3FrQU9vQTFFZ0IxQUdva1FLb0ExQWpCVkFIb0VZS29BNUFqUlJBSFlBYUtZQTZBRFZTQUhVQWFxUUE2Z0RVU0FIVUFTamhuT2RxV2dCeXYyWkVFc0JLckt0cStqSVRVNE9pOVF0c1ZvY0x6eTE5ZXpSLzY5UVQwUVFBamdSdlZNcTZsaG1SQkt3dHVoSUpOcytrUjQySjEzY1dlenMrb2FCcFNpUUJUc05rOFhOZlRrRFp0amxSQkpUNjVmOWVmQVdOazZJSUFQSUYveW0rOGVTbFBVVTd1RzFZeS9OUDA3SHVoeXZ2SGl3ZzN6ZWNoVk80MTA4TWR4YnFCbmhEQWFBaXNGdHBhTDNjQ1FEVk5FK0wwampwTlV4cXdVaGJzUDdFK1JZOWREQUtSUTFacWNUSWNuL25zREgxM2tCeGdmL1ZQdjhiODFzbUgvTTlkRE1BQUFBQVNVVk9SSzVDWUlJPSIvPgo8bWFzayBpZD0ibWFzazEiPgogIDxnIGZpbHRlcj0idXJsKCNhbHBoYSkiPgo8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHN0eWxlPSJmaWxsOnJnYigwJSwwJSwwJSk7ZmlsbC1vcGFjaXR5OjAuMjUwOTg7c3Ryb2tlOm5vbmU7Ii8+CiAgPC9nPgo8L21hc2s+CjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZWFyMCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSI0OS45MzkyMDEiIHkxPSIwLjI1NzgxMiIgeDI9IjQ5LjkzOTIwMSIgeTI9Ijk5Ljc0MjMwMiIgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjY0LDAsMCwwLjY0LDAsMCkiPgo8c3RvcCBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOnJnYigxMDAlLDEwMCUsMTAwJSk7c3RvcC1vcGFjaXR5OjE7Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6cmdiKDEwMCUsMTAwJSwxMDAlKTtzdG9wLW9wYWNpdHk6MDsiLz4KPC9saW5lYXJHcmFkaWVudD4KPGNsaXBQYXRoIGlkPSJjbGlwMiI+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0Ii8+CjwvY2xpcFBhdGg+CjxnIGlkPSJzdXJmYWNlMjgiIGNsaXAtcGF0aD0idXJsKCNjbGlwMikiPgo8cGF0aCBzdHlsZT0iIHN0cm9rZTpub25lO2ZpbGwtcnVsZTpldmVub2RkO2ZpbGw6dXJsKCNsaW5lYXIwKTsiIGQ9Ik0gNDUuMzQzNzUgNjMuNTYyNSBDIDQ2LjM1MTU2MiA2My45NTcwMzEgNDcuNTAzOTA2IDYzLjkyOTY4OCA0OC41MTk1MzEgNjMuNDQxNDA2IEwgNjEuNjk1MzEyIDU3LjEwMTU2MiBDIDYzLjA4MjAzMSA1Ni40MzM1OTQgNjMuOTYwOTM4IDU1LjAzMTI1IDYzLjk2MDkzOCA1My40OTYwOTQgTCA2My45NjA5MzggMTAuNTAzOTA2IEMgNjMuOTYwOTM4IDguOTY4NzUgNjMuMDgyMDMxIDcuNTY2NDA2IDYxLjY5NTMxMiA2Ljg5ODQzOCBMIDQ4LjUxOTUzMSAwLjU1ODU5NCBDIDQ3LjE4MzU5NCAtMC4wODIwMzEyIDQ1LjYyMTA5NCAwLjA3NDIxODggNDQuNDQ5MjE5IDAuOTI1NzgxIEMgNDQuMjgxMjUgMS4wNDY4NzUgNDQuMTIxMDk0IDEuMTgzNTk0IDQzLjk3MjY1NiAxLjMzMjAzMSBMIDE4Ljc1IDI0LjM0NzY1NiBMIDcuNzYxNzE5IDE2LjAwNzgxMiBDIDYuNzM4MjgxIDE1LjIzMDQ2OSA1LjMwODU5NCAxNS4yOTI5NjkgNC4zNTkzNzUgMTYuMTU2MjUgTCAwLjgzMjAzMSAxOS4zNjMyODEgQyAtMC4zMjgxMjUgMjAuNDIxODc1IC0wLjMyODEyNSAyMi4yNSAwLjgzMjAzMSAyMy4zMDg1OTQgTCAxMC4zNTkzNzUgMzIgTCAwLjgzMjAzMSA0MC42OTE0MDYgQyAtMC4zMjgxMjUgNDEuNzUgLTAuMzI4MTI1IDQzLjU3ODEyNSAwLjgzMjAzMSA0NC42MzY3MTkgTCA0LjM1OTM3NSA0Ny44NDM3NSBDIDUuMzA4NTk0IDQ4LjcwNzAzMSA2LjczODI4MSA0OC43Njk1MzEgNy43NjE3MTkgNDcuOTkyMTg4IEwgMTguNzUgMzkuNjUyMzQ0IEwgNDMuOTcyNjU2IDYyLjY2Nzk2OSBDIDQ0LjM3MTA5NCA2My4wNjY0MDYgNDQuODM5ODQ0IDYzLjM2NzE4OCA0NS4zNDM3NSA2My41NjI1IFogTSA0Ny45NzI2NTYgMTcuNDcyNjU2IEwgMjguODMyMDMxIDMyIEwgNDcuOTcyNjU2IDQ2LjUyNzM0NCBaIE0gNDcuOTcyNjU2IDE3LjQ3MjY1NiAiLz4KPC9nPgo8Y2xpcFBhdGggaWQ9ImNsaXAxIj4KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiLz4KPC9jbGlwUGF0aD4KPGcgaWQ9InN1cmZhY2UzMSIgY2xpcC1wYXRoPSJ1cmwoI2NsaXAxKSI+CjxwYXRoIHN0eWxlPSIgc3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDpyZ2IoMCUsMzkuNjA3ODQ0JSw2Ni4yNzQ1MTIlKTtmaWxsLW9wYWNpdHk6MTsiIGQ9Ik0gNjEuNzM0Mzc1IDYuOTEwMTU2IEwgNDguNTQ2ODc1IDAuNTU4NTk0IEMgNDcuMDIzNDM4IC0wLjE3NTc4MSA0NS4xOTkyMTkgMC4xMzY3MTkgNDQgMS4zMzIwMzEgTCAwLjgzMjAzMSA0MC42OTE0MDYgQyAtMC4zMjgxMjUgNDEuNzUgLTAuMzI4MTI1IDQzLjU3ODEyNSAwLjgzMjAzMSA0NC42MzY3MTkgTCA0LjM1OTM3NSA0Ny44NDM3NSBDIDUuMzEyNSA0OC43MDcwMzEgNi43NDIxODggNDguNzY5NTMxIDcuNzY1NjI1IDQ3Ljk5MjE4OCBMIDU5Ljc1IDguNTU4NTk0IEMgNjEuNDk2MDk0IDcuMjM0Mzc1IDY0IDguNDc2NTYyIDY0IDEwLjY2Nzk2OSBMIDY0IDEwLjUxMTcxOSBDIDY0IDguOTc2NTYyIDYzLjEyMTA5NCA3LjU3ODEyNSA2MS43MzQzNzUgNi45MTAxNTYgWiBNIDYxLjczNDM3NSA2LjkxMDE1NiAiLz4KPHVzZSB4bGluazpocmVmPSIjaW1hZ2UxNCIvPgo8dXNlIHhsaW5rOmhyZWY9IiNpbWFnZTI1Ii8+Cjx1c2UgeGxpbms6aHJlZj0iI3N1cmZhY2UyOCIgbWFzaz0idXJsKCNtYXNrMSkiLz4KPC9nPgo8L2RlZnM+CjxnIGlkPSJzdXJmYWNlMSI+Cjx1c2UgeGxpbms6aHJlZj0iI3N1cmZhY2UzMSIgbWFzaz0idXJsKCNtYXNrMCkiLz4KPC9nPgo8L3N2Zz4K
         - name: Define branding favicon ico (base64)
          set_fact:
            favicon_ico_b64: |
              AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAACMuAAAjLgAAAAAAAAAAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////27uP/1qxt/9WUM//runL/9OLI//z69///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9+7i/9mpYv/Bdwr/wncH/+iYIP/upz7/78F9//Xjyf/8+vf///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Xq2f/aplf/yXwI/8J2BP/Bdwn/6Jgf//GeIv/vnSP/7qY5/++/eP/14sX//Pn1///////////////////////////////////////////////////////////////////////////////////////////////////////z5M//2J9K/81+CP/LfAb/xHgH/8J4C//omSH/8J8l//CfJf/wniT/8J4k/+6lOP/wv3j/9ujT///////////////////////////////////////////////////////////////////////////////////////+/v7/8d/E/9eaQP/Ofwj/zn8J/8x+Cf/FeQn/w3oN/+qZI//xnyf/8Z8n//GfJ//xnyf/8Z8m//GfJ//utF3//////////////////////////////////////////////////////////////////////////////////v79/+/au//Vljf/zn8K/86AC//OgAv/zH8L/8V6C//Eew//6pol//GgKf/xoCn/8aAp//GgKf/xoCn/8aAp//GhLP////////////////////////////////////////////////////////////////////////////79+//s1LH/1ZMx/86ADP/PgQ3/z4EN/8+BDf/NgA3/xnsN/8V8Ef/qmyb/8aEq//GhKv/xoSr/8aEq//GhKv/xoSr/8aEq/////////v7/9e3i//Pq3P/+/fz////////////////////////////////////////////9+/j/6s2k/9OPKv/PgQ3/z4IP/8+CD//Pgg//z4IP/82BD//GfA//xX0R/+qcKP/xoiz/8aIs//GiLP/xoiz/8aIs//GiLP/xoiz///7+/+nXvP++iz//uoMy/9zAl//7+PP//////////////////////////////////Pn1/+fGlv/SjSX/z4IP/8+DEf/PgxH/z4MR/8+DEf/PgxH/zYEQ/8d+Ev/MjzX/7KM2//GjLv/xoy7/8aMu//GjLv/xoy7/8aMu//GjLv/jzKv/uoMy/69vEf+vbxH/snUb/86ob//17eL///////////////////////v38f/lwIr/0osi/9CDEv/QhBP/0IQT/9CEE//QhBP/0IQT/9CDEv/Phhr/2Kpm/+3bvv/xsFH/8aIu//GjMP/xozD/8aMw//GjMP/xozD/8aMw/7mCMf+vcRP/sHIV/7ByFf+wcRT/sHIV/8KTTP/q28T//v79///////69Oz/4rp+/9GJH//QhBT/0IUV/9CFFf/QhRX/0IUV/9CFFf/QhBP/048q/+TBjf/59O3//Pbs//KzVP/xoy//8aQx//GkMf/xpDH/8aQx//GkMf/xpDH/0a13/7R4IP+wchb/sXMX/7FzF/+wcxf/rXAV/7N/Mf/ZwZ//8+na/+G0c//SiR3/0YYW/9GGF//Rhhf/0YYX/9GGF//Rhhb/0IYX/9icQv/t1bL//fv4///////99uz/8rRW//GkMf/xpTP/8aUz//GlM//xpTP/8aUz//GlM//79/L/2bqN/7V7Jf+xcxj/sXQZ/65yGf+qcBn/pWwX/693I//Qkzv/0oke/9GHGP/Rhxn/0YcZ/9GHGf/Rhxn/0YcY/9KKHv/drGL/9ObS//7+/v////////////327P/ztVj/8aUz//GmNf/xpjX/8aY1//GmNf/xpjX/8aY1///////9+/j/3sOc/7d/LP+uchn/q3Eb/6ZuG/+ucxv/x4Ea/9GHGf/RiBv/0Ygb/9GIG//RiBv/0Ygb/9GHGf/UkS3/5cCJ//ny6f///////////////////////fbs//O1Wv/ypTX/8qY3//KmN//ypjf/8qY3//KmN//ypjf////////////+/fv/4Mqp/7OAM/+mbxz/sXUd/8mEHf/SiR3/0okd/9KJHf/SiR3/0okd/9KJHf/SiR7/2JxD/+zTrv/8+vf////////////////////////////99u3/87Zb//KmNv/ypzj/8qc4//KnOP/ypzj/8qc4//KnOP/////////////////+/v3/4M6z/7uEMv/Lhh7/0oof/9KKH//Sih//0oof/9KKH//Sih//0Yke/9mkVP/z5dD//v7+//////////////////////////////////337f/zt1z/8qc4//KoOv/yqDr/8qg6//KoOv/yqDr/8qg6//////////////////79/f/u2Lj/1ZU4/9OKIP/TiyH/04sh/9OLIf/TiyH/04sh/9GKIf/BgCD/vpFQ/+vfzv////7//////////////////////////////////fft//O3Xv/yqDr/8qk8//KpPP/yqTz/8qk8//KpPP/yqTz////////////9/Pr/7NSv/9eaP//TjCL/04wj/9OMI//TjCP/04wj/9OMI//OiSP/un0j/6p0I/+qcyL/uopC/+LOrv/9+/n////////////////////////////99+3/87hf//KpPP/yqj7/8qo+//KqPv/yqj7/8qo+//KqPv///////Pr3/+rOpP/XmDr/040k/9ONJf/TjSX/040l/9ONJP/TjCP/yYcl/7R7Jf+qdCX/rXYl/7F4Jf+zeSP/uYMx/9e4iv/59Oz///////////////////////337f/zuGH/8qk+//KqQP/yqkD/8qpA//KqQP/yqkD/8qo///r28f/nx5j/1pY2/9SOJf/Ujif/1I4n/9SOJ//UjSX/1pU0/86XRf+wein/q3Yn/694J/+yeif/tXwn/7Z9J/+2fCb/t34p/8ujZv/x5tX//////////////////fft//O5Yv/yqj//8qtB//KrQf/yq0H/8qtB//KrQf/yq0H/472F/9aVNP/Ujyj/1I8p/9SPKf/Ujyn/1I8o/9meR//r0ar/8ejb/8qodv+yfCv/tHwo/7Z9Kf+3fin/t34p/7d+Kf+3fin/tn0o/8KSS//n07b//fz6///////99+3/9Lpj//KrQf/yrEP/8qxD//KsQ//yrEP/8qxD//KsQ//Zn0r/1JAq/9WQK//VkCv/1ZAq/9WRLf/erGP/8uHK//79/f//////+fTu/9S0g/+5gjD/uH8q/7h/K/+4fyv/uH8r/7h/K/+4fyv/t34p/7yIOf/avZP/+fXw//337v/0u2X/86xD//OtRf/zrUX/861F//OtRf/zrUX/861E/+zWtf/aok7/1ZAr/9WQK//Xlzj/5LyC//fv4///////////////////////+/jz/9q9kv+7hjb/uIAs/7iALf+4gC3/uIAt/7iALf+4gC3/uIAs/7iBMf/LpnH/7d3G//S6Zf/zrEX/861H//OtR//zrUf/861H//OtR//zrUb//v79//Hfxv/eql//26RS/+vPp//7+PP//////////////////////////////////Pr3/9/Fn/+9iTz/uYAu/7mBL/+5gS//uYEv/7mBL/+5gS//t4Av/7J9L/+/kEr/7K1P//OuSP/zrkj/865I//OuSP/zrkj/865I//OuR/////////7+//nx5//37uL//v37/////////////////////////////////////////////fz6/+PNrf/AjkP/uYIv/7qDMf+6gzH/uoMx/7qDMf+4gjH/s38x/7eCM//pqEb/9K9K//OvSv/zr0r/869K//OvSv/zr0r/869J/////////////////////////////////////////////////////////////////////////////v79/+fVuf/Ckkv/uoMx/7qEM/+6hDP/uoQz/7mDM/+0gDP/t4Q2/+qpSf/0sEz/87BM//OwTP/zsEz/87BM//OwTP/zsEv///////////////////////////////////////////////////////////////////////////////////7+/+vbxP/Fl1P/u4Q0/7uFNf+7hTX/uYQ1/7WBNf+4hTj/6qpL//SxTv/zsU7/87FO//OxTv/zsU7/87FO//OyUP///////////////////////////////////////////////////////////////////////////////////////////+7hzv/JnV7/u4Y2/7yGN/+6hTf/tYI3/7mGOv/qqkz/9LFP//OxT//zsU//87FP//OxTv/zsU//8MB5//////////////////////////////////////////////////////////////////////////////////////////////////Ln2P/MpGj/vIc4/7uGOf+1gzn/uYc8/+qrTv/0slH/87JR//OyUP/zsVD/8bZf//LLkv/47Nr///////////////////////////////////////////////////////////////////////////////////////////////////////Xt4f/Qq3X/u4g7/7WEOv+5hz7/6qxQ//SzUv/zslL/8bhj//LMlP/36NH//fv4//////////////////////////////////////////////////////////////////////////////////////////////////////////////////fx6f/SsYD/t4dA/7yKQf/rrlP/8rtp//LOmv/36dX//fv5//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////fy6//VuIz/1KZh/+7Kk//36tb//fv5////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
        - name: Create /tmp/favicon.svg from base64
          copy:
            dest: /tmp/favicon.svg
            content: "{{ favicon_svg_b64 | b64decode }}"
            mode: "0644"
          no_log: true
        - name: Create /tmp/favicon.ico from base64
          copy:
            dest: /tmp/favicon.ico
            content: "{{ favicon_ico_b64 | b64decode }}"
            mode: "0644"
          no_log: true
        - name: Copy GitHub private key from local file
          copy:
            dest: /opt/vscode/pem/github_pem
            content: "{{ pem_github }}"
            owner: vscode
            group: vscode
            mode: "0600"
        - name: Generate Code user.json
          copy:
            dest: "/opt/vscode/settings/user.json" 
            content: |
              {
                "editor.tabSize": 2,
                "editor.insertSpaces": true,
                "editor.detectIndentation": false,
                "editor.defaultFormatter": "esbenp.prettier-vscode",
                "python.formatting.provider": "black",
                "editor.formatOnSave": true,
                "editor.minimap.enabled": false,
                "workbench.colorTheme": "Tokyo Night",
                "window.commandCenter": false,
                "editor.lineNumbers": "on",
                "editor.stickyScroll.enabled": false,
                "files.autoSave": "onWindowChange",
                "workbench.editorAssociations": {
                    "*.md": "vscode.markdown.preview.editor",
                    "*.MD": "vscode.markdown.preview.editor"
                },
                "workbench.sideBar.location": "left",
                "workbench.statusBar.visible": true,
                "workbench.tree.enableStickyScroll": true,
                "workbench.view.alwaysShowHeaderActions": false,
                "window.density.editorTabHeight": "default",
                "git.autofetch": false,
                "git.enableSmartCommit": true,
                "git.postCommitCommand": "sync",
                "ansible.python.interpreterPath": "/usr/bin/python3",
                "ansible.validation.lint.enabled": true,
                "terminal.integrated.defaultProfile.linux": "bash",
                "security.workspace.trust.enabled": false
              }
            owner: vscode
            group: vscode
            mode: "0644"

    - name: Create docker config files
      block:
        - name: Generate dockerfile
          copy:
            dest: "/opt/vscode/docker/Dockerfile"
            content: |-
              FROM ghcr.io/coder/code-server:latest

              USER root

              # Packages

              RUN apt-get update && apt-get install -y \
                git unzip nano wget curl jq sudo gnupg software-properties-common \
                openssh-client \
                python3 python3-pip python3-venv \
                && rm -rf /var/lib/apt/lists/*

              RUN apt-get update \
              && apt-get install -y ansible \
              && rm -rf /var/lib/apt/lists/*

              RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
              && apt-get install -y nodejs \
              && rm -rf /var/lib/apt/lists/*

              RUN curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp.gpg \
              && echo "deb [signed-by=/usr/share/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
              > /etc/apt/sources.list.d/hashicorp.list \
              && apt-get update && apt-get install -y terraform \
              && rm -rf /var/lib/apt/lists/*

              RUN wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.93.8/terragrunt_linux_amd64 \
              && install -m 0755 terragrunt_linux_amd64 /usr/local/bin/terragrunt \
              && rm terragrunt_linux_amd64

              RUN curl -fsSL https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip \
              && unzip awscliv2.zip && ./aws/install && rm -rf aws awscliv2.zip && rm -rf ./aws/install

              RUN echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/coder \
              && chmod 0440 /etc/sudoers.d/coder

              # Git identity (system-wide)
              RUN git config --system user.name "{{ admin_name }}" \
              && git config --system user.email "{{ admin_email }}"

              # Git commit template (system-wide)
              RUN printf "Describe the change in one sentence:\n" > /etc/gitmessage \
              && git config --system commit.template /etc/gitmessage

              # SSH (system-wide config + known_hosts)
              RUN mkdir -p /etc/ssh/ssh_config.d \
                && ssh-keyscan github.com > /etc/ssh/ssh_known_hosts \
                && chmod 0644 /etc/ssh/ssh_known_hosts

              RUN cat > /etc/ssh/ssh_config.d/github.conf <<'EOF'
              Host github.com
                HostName github.com
                User git
                IdentityFile /home/coder/.ssh/id_ed25519
                IdentitiesOnly yes
                StrictHostKeyChecking accept-new
                UserKnownHostsFile /etc/ssh/ssh_known_hosts
              EOF

              RUN chmod 0644 /etc/ssh/ssh_config.d/github.conf \
                && mkdir -p /home/coder/.ssh \
                && chmod 0755 /home/coder/.ssh

              # Ensure permissions
              RUN mkdir -p \
                    /home/coder/.local/share/code-server/extensions \
                    /home/coder/.local/share/code-server/User \
                    /home/coder/.local/share/code-server/logs \
                    /home/coder/.local/share/code-server/Machine \
                  && chown -R coder:coder /home/coder/.local

              USER coder

              # SET EXTENSIONS_GALLERY

              ENV EXTENSIONS_GALLERY='{"serviceUrl":"https://marketplace.visualstudio.com/_apis/public/gallery","cacheUrl":"https://vscode.blob.core.windows.net/gallery/index","itemUrl":"https://marketplace.visualstudio.com/items"}'

              # Extensions

              RUN \
              {% for ext in extensions %}
                code-server --install-extension "{{ ext }}"; \
              {% endfor %}
                true
                
              EXPOSE 8080
              CMD ["code-server", "--bind-addr", "0.0.0.0:8080", "--auth", "none", "/home/coder/project"]
            owner: vscode
            group: vscode
            mode: "0644"
        - name: Generate docker-compose.yml
          copy:
            dest: "/opt/vscode/docker/docker-compose.yml"
            content: |-
              services:
                vscode:
                  build:
                    context: ..
                    dockerfile: docker/Dockerfile
                  container_name: vscode
                  user: "{{ vscode_uid }}:{{ vscode_gid }}"
                  restart: always
                  ports:
                    - "80:8080"
                  volumes:
                    - ../data:/home/coder/project
                    - /tmp/favicon.ico:/usr/lib/code-server/src/browser/media/favicon.ico:ro
                    - /tmp/favicon-dark-support.svg:/usr/lib/code-server/src/browser/media/favicon-dark-support.svg:ro
                    - ../settings/user.json:/home/coder/.local/share/code-server/User/settings.json
                    - ../pem/github_pem:/home/coder/.ssh/id_ed25519:ro
            owner: vscode
            group: vscode
            mode: "0644"
        - name: Create systemd service for Code
          copy:
            dest: "/etc/systemd/system/vscode-server.service"
            content: |
              [Unit]
              Description=Code Docker Compose
              Requires=docker.service
              After=docker.service

              [Service]
              Type=oneshot
              RemainAfterExit=yes
              # Rebuild + Up
              ExecStart=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml build
              ExecStart=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml up -d

              # Down cuando paras el servicio
              ExecStop=/usr/bin/docker compose -f /opt/vscode/docker/docker-compose.yml down
              TimeoutStartSec=0

              [Install]
              WantedBy=multi-user.target
            mode: "0644"
        - name: Enable and start vscode-server service
          systemd:
            name: vscode-server
            enabled: true
            state: restarted
            daemon_reload: true